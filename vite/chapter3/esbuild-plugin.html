<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Esbuld plugin | RE 的学习小站</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="对 Javascript 学习的记录总结">
    
    <link rel="preload" href="/yg-notes/assets/css/0.styles.0edbbd45.css" as="style"><link rel="preload" href="/yg-notes/assets/js/app.fe4da5f9.js" as="script"><link rel="preload" href="/yg-notes/assets/js/2.7fcefaab.js" as="script"><link rel="preload" href="/yg-notes/assets/js/29.5bda923a.js" as="script"><link rel="prefetch" href="/yg-notes/assets/js/10.55c1a34f.js"><link rel="prefetch" href="/yg-notes/assets/js/11.f1b8bc6f.js"><link rel="prefetch" href="/yg-notes/assets/js/12.7b9adcb0.js"><link rel="prefetch" href="/yg-notes/assets/js/13.0801c239.js"><link rel="prefetch" href="/yg-notes/assets/js/14.bf9edf1c.js"><link rel="prefetch" href="/yg-notes/assets/js/15.cfe937f2.js"><link rel="prefetch" href="/yg-notes/assets/js/16.fc68a9ab.js"><link rel="prefetch" href="/yg-notes/assets/js/17.9b6266f0.js"><link rel="prefetch" href="/yg-notes/assets/js/18.8b37e4dc.js"><link rel="prefetch" href="/yg-notes/assets/js/19.f6f92a4c.js"><link rel="prefetch" href="/yg-notes/assets/js/20.4a7aa93e.js"><link rel="prefetch" href="/yg-notes/assets/js/21.77422be8.js"><link rel="prefetch" href="/yg-notes/assets/js/22.c7d89dfd.js"><link rel="prefetch" href="/yg-notes/assets/js/23.da982052.js"><link rel="prefetch" href="/yg-notes/assets/js/24.6913467f.js"><link rel="prefetch" href="/yg-notes/assets/js/25.333c73b9.js"><link rel="prefetch" href="/yg-notes/assets/js/26.0be78558.js"><link rel="prefetch" href="/yg-notes/assets/js/27.0b3e84a5.js"><link rel="prefetch" href="/yg-notes/assets/js/28.8af7b439.js"><link rel="prefetch" href="/yg-notes/assets/js/3.2d6fd0ee.js"><link rel="prefetch" href="/yg-notes/assets/js/30.aa89ef6b.js"><link rel="prefetch" href="/yg-notes/assets/js/4.4e332086.js"><link rel="prefetch" href="/yg-notes/assets/js/5.89eafe95.js"><link rel="prefetch" href="/yg-notes/assets/js/6.0a121ed3.js"><link rel="prefetch" href="/yg-notes/assets/js/7.484f9988.js"><link rel="prefetch" href="/yg-notes/assets/js/8.89b2441f.js"><link rel="prefetch" href="/yg-notes/assets/js/9.cb6c2bcf.js">
    <link rel="stylesheet" href="/yg-notes/assets/css/0.styles.0edbbd45.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/yg-notes/" class="home-link router-link-active"><!----> <span class="site-name">RE 的学习小站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/yg-notes/jsbase/chapter1/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/yg-notes/css/chapter1/" class="nav-link">
  CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="vue" class="mobile-dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/vue3/chapter1/" class="nav-link">
  vue3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="compile Menu" class="dropdown-title"><span class="title">compile</span> <span class="arrow down"></span></button> <button type="button" aria-label="compile Menu" class="mobile-dropdown-title"><span class="title">compile</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/compiler/chapter1/" class="nav-link">
  Compiler
</a></li><li class="dropdown-item"><!----> <a href="/yg-notes/vite/chapter1/" class="nav-link">
  vite小册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="algorithm Menu" class="dropdown-title"><span class="title">algorithm</span> <span class="arrow down"></span></button> <button type="button" aria-label="algorithm Menu" class="mobile-dropdown-title"><span class="title">algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/algorithm/chapter1/" class="nav-link">
  algorithm
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/yg-notes/jsbase/chapter1/" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/yg-notes/css/chapter1/" class="nav-link">
  CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vue" class="dropdown-title"><span class="title">vue</span> <span class="arrow down"></span></button> <button type="button" aria-label="vue" class="mobile-dropdown-title"><span class="title">vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/vue3/chapter1/" class="nav-link">
  vue3
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="compile Menu" class="dropdown-title"><span class="title">compile</span> <span class="arrow down"></span></button> <button type="button" aria-label="compile Menu" class="mobile-dropdown-title"><span class="title">compile</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/compiler/chapter1/" class="nav-link">
  Compiler
</a></li><li class="dropdown-item"><!----> <a href="/yg-notes/vite/chapter1/" class="nav-link">
  vite小册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="algorithm Menu" class="dropdown-title"><span class="title">algorithm</span> <span class="arrow down"></span></button> <button type="button" aria-label="algorithm Menu" class="mobile-dropdown-title"><span class="title">algorithm</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/yg-notes/algorithm/chapter1/" class="nav-link">
  algorithm
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vite 小册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yg-notes/vite/chapter1/" class="sidebar-link">module standard</a></li><li><a href="/yg-notes/vite/chapter1/quick-start.html" class="sidebar-link">quick-start</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vite-project-framework</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yg-notes/vite/chapter2/" class="sidebar-link">vite中接入 css</a></li><li><a href="/yg-notes/vite/chapter2/lint.html" class="sidebar-link">代码规范：利用lint工具</a></li><li><a href="/yg-notes/vite/chapter2/assets.html" class="sidebar-link">vite 中处理各种静态资源</a></li><li><a href="/yg-notes/vite/chapter2/pre-bundling.html" class="sidebar-link">依赖预构建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>双引擎架构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yg-notes/vite/chapter3/" aria-current="page" class="sidebar-link">Esbuild</a></li><li><a href="/yg-notes/vite/chapter3/esbuild-plugin.html" aria-current="page" class="active sidebar-link">Esbuld plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#为什么-esbuild-性能极高" class="sidebar-link">为什么 Esbuild 性能极高？</a></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#esbuild-功能使用" class="sidebar-link">Esbuild 功能使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#_1-命令行调用" class="sidebar-link">1. 命令行调用</a></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#_2-代码调用" class="sidebar-link">2. 代码调用</a></li></ul></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#esbuild-插件开发" class="sidebar-link">Esbuild 插件开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#钩子函数的使用" class="sidebar-link">钩子函数的使用</a></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#实战-1-cdn-依赖拉取插件" class="sidebar-link">实战 1: CDN 依赖拉取插件</a></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#实战-2-实现-html-构建插件" class="sidebar-link">实战 2: 实现 HTML 构建插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/yg-notes/vite/chapter3/esbuild-plugin.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="esbuld-plugin"><a href="#esbuld-plugin" class="header-anchor">#</a> Esbuld plugin</h1> <p>可否认，作为 Vite 的双引擎之一，Esbuild 在很多关键的构建阶段(如<code>依赖预编译</code>、<code>TS 语法转译</code>、<code>代码压缩</code>)让 Vite 获得了相当优异的性能，是 Vite 高性能的得力助手。无论是在 Vite 的配置项还是源码实现中，都包含了不少 Esbuild 本身的基本概念和高阶用法。</p> <h2 id="为什么-esbuild-性能极高"><a href="#为什么-esbuild-性能极高" class="header-anchor">#</a> 为什么 Esbuild 性能极高？</h2> <p>Esbuild 是由 Figma 的 CTO 「Evan Wallace」基于 Golang 开发的一款打包工具，相比传统的打包工具，主打性能优势，在构建速度上可以比传统工具快 <code>10~100</code> 倍。那么，它是如何达到这样超高的构建性能的呢？主要原因可以概括为 4 点。</p> <ol><li><p><strong>使用 Golang 开发</strong>，构建逻辑代码直接被编译为原生机器码，而不用像 JS 一样先代码解析为字节码，然后转换为机器码，大大节省了程序运行时间。</p></li> <li><p><strong>多核并行</strong>。内部打包算法充分利用多核 CPU 优势，所有的步骤尽可能并行，这也是得益于 Go 当中多线程共享内存的优势。</p></li> <li><p><strong>从零造轮子</strong>。 几乎没有使用任何第三方库，所有逻辑自己编写，大到 AST 解析，小到字符串的操作，保证极致的代码性能。</p></li> <li><p><strong>高效的内存利用</strong>。Esbuild 中从头到尾尽可能地复用一份 AST 节点数据，而不用像 JS 打包工具中频繁地解析和传递 AST 数据（如 string -&gt; TS -&gt; JS -&gt; string)，造成内存的大量浪费。</p></li></ol> <h2 id="esbuild-功能使用"><a href="#esbuild-功能使用" class="header-anchor">#</a> Esbuild 功能使用</h2> <p>首先我们执行 <code>pnpm init -y</code> 新建一个项目, 然后通过如下的命令完成 Esbuild 的安装:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">pnpm</span> i esbuild
</code></pre></div><p>使用 Esbuild 有 2 种方式，分别是 <strong>命令行调用</strong>和<strong>代码调用</strong>。</p> <h3 id="_1-命令行调用"><a href="#_1-命令行调用" class="header-anchor">#</a> 1. 命令行调用</h3> <p>命令行方式调用也是最简单的使用方式。我们先来写一些示例代码，新建<code>src/index.jsx</code>文件，内容如下:</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// src/index.jsx</span>
<span class="token keyword">import</span> Server <span class="token keyword">from</span> <span class="token string">&quot;react-dom/server&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">Greet</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Hello, juejin!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Server<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Greet</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意安装一下所需的依赖，在终端执行如下的命令:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">pnpm</span> <span class="token function">install</span> react react-dom
</code></pre></div><p>接着到<code>package.json</code>中添加<code>build</code>脚本:</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./node_modules/.bin/esbuild src/index.jsx --bundle --outfile=dist/out.js&quot;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>现在，你可以在终端执行<code>pnpm run build</code>，可以发现如下的日志信息:</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意：如果运行pnpm run build报错，使用npm run build</p></div> <img src="/yg-notes/assets/vite/9-1.webp"> <p>说明我们已经成功通过命令行完成了 Esbuild 打包！但命令行的使用方式不够灵活，只能传入一些简单的命令行参数，稍微复杂的场景就不适用了，所以一般情况下我们还是会用代码调用的方式。</p> <h3 id="_2-代码调用"><a href="#_2-代码调用" class="header-anchor">#</a> 2. 代码调用</h3> <p>Esbuild 对外暴露了一系列的 API，主要包括两类: <code>Build API</code>和<code>Transform API</code>，我们可以在 <code>Nodejs</code> 代码中通过调用这些 API 来使用 Esbuild 的各种功能。</p> <h4 id="项目打包-build-api"><a href="#项目打包-build-api" class="header-anchor">#</a> 项目打包——Build API</h4> <p>Build API主要用来进行项目打包，包括<code>build</code>、<code>buildSync</code>和<code>serve</code>三个方法。</p> <p>首先我们来试着在 <code>Node.js</code> 中使用<code>build</code> 方法。你可以在项目根目录新建<code>build.js</code>文件，内容如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> build<span class="token punctuation">,</span> buildSync<span class="token punctuation">,</span> serve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 异步方法，返回一个 Promise</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// ----  如下是一些常见的配置  --- </span>
    <span class="token comment">// 当前项目根目录</span>
    absWorkingDir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 入口文件列表，为一个数组</span>
    entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/index.jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 打包产物目录</span>
    outdir<span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否需要打包，一般设为 true</span>
    bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 模块格式，包括`esm`、`commonjs`和`iife`</span>
    format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 需要排除打包的依赖列表</span>
    external<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否开启自动拆包</span>
    splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否生成 SourceMap 文件</span>
    sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否生成打包的元信息文件</span>
    metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否进行代码压缩</span>
    minify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否开启 watch 模式，在 watch 模式下代码变动则会触发重新打包</span>
    watch<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否将产物写入磁盘</span>
    write<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// Esbuild 内置了一系列的 loader，包括 base64、binary、css、dataurl、file、js(x)、ts(x)、text、json</span>
    <span class="token comment">// 针对一些特殊的文件，调用不同的 loader 进行加载</span>
    loader<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'.png'</span><span class="token operator">:</span> <span class="token string">'base64'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>随后，你在命令行执行<code>node build.js</code>，就能在控制台发现如下日志信息:</p> <img src="/yg-notes/assets/vite/9-2.webp"> <p>以上就是 Esbuild 打包的元信息，这对我们编写插件扩展 Esbuild 能力非常有用。</p> <p>接着，我们再观察一下 dist 目录，发现打包产物和相应的 SourceMap 文件也已经成功写入磁盘:</p> <img src="/yg-notes/assets/vite/9-3.webp"> <p>其实<code>buildSync</code>方法的使用几乎相同，如下代码所示:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同步方法</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">buildSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 省略一系列的配置</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但我并不推荐大家使用 <code>buildSync</code> 这种同步的 API，它们会导致两方面不良后果。一方面容易使 Esbuild 在当前线程阻塞，丧失<strong>并发任务处理</strong>的优势。另一方面，Esbuild 所有插件中都不能使用任何异步操作，这给<strong>插件开发</strong>增加了限制。</p> <p>因此我更推荐大家使用<code>build</code>这个异步 API，它可以很好地避免上述问题。</p> <p>在项目打包方面，除了<code>build</code>和<code>buildSync</code>，Esbuild 还提供了另外一个比较强大的 API——<code>serve</code>。这个 API 有 3 个特点。</p> <ol><li>开启 <code>serve</code> 模式后，将在指定的端口和目录上搭建一个<strong>静态文件服务</strong>，这个服务器用原生 Go 语言实现，性能比 Nodejs 更高。</li> <li>类似 <code>webpack-dev-server</code>，所有的产物文件都默认不会写到磁盘，而是放在内存中，通过请求服务来访问。</li> <li><strong>每次请求</strong>到来时，都会进行重新构建(<code>rebuild</code>)，永远返回新的产物。</li></ol> <blockquote><p>值得注意的是，触发 rebuild 的条件并不是代码改动，而是新的请求到来。</p></blockquote> <p>下面，我们通过一个具体例子来感受一下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// build.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> build<span class="token punctuation">,</span> buildSync<span class="token punctuation">,</span> serve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">serve</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      port<span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span>
      <span class="token comment">// 静态资源目录</span>
      servedir<span class="token operator">:</span> <span class="token string">'./dist'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      absWorkingDir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/index.jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
      splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      ignoreAnnotations<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">server</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP Server starts at port&quot;</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>后续每次在浏览器请求都会触发 Esbuild 重新构建，而每次重新构建都是一个增量构建的过程，耗时也会比首次构建少很多(一般能减少 70% 左右)。</p> <blockquote><p>Serve API 只适合在开发阶段使用，不适用于生产环境。</p></blockquote> <h4 id="单文件转译-transform-api"><a href="#单文件转译-transform-api" class="header-anchor">#</a> 单文件转译——Transform API</h4> <p>除了项目的打包功能之后，Esbuild 还专门提供了单文件编译的能力，即<code>Transform API</code>，与 <code>Build API</code> 类似，它也包含了同步和异步的两个方法，分别是<code>transformSync</code>和<code>transform</code>。下面，我们具体使用下这些方法。</p> <p>首先，在项目根目录新建<code>transform.js</code>，内容如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// transform.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> transform<span class="token punctuation">,</span> transformSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 第一个参数是代码字符串，第二个参数为编译配置</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transform</span><span class="token punctuation">(</span>
    <span class="token string">&quot;const isNull = (str: string): boolean =&gt; str.length &gt; 0;&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      loader<span class="token operator">:</span> <span class="token string">&quot;tsx&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>transformSync</code> 的用法类似，换成同步的调用方式即可。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> runTransform <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformSync</span><span class="token punctuation">(</span><span class="token comment">/* 参数和 transform 相同 */</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不过由于同步的 API 会使 Esbuild 丧失<strong>并发任务处理</strong>的优势（<code>Build API</code>的部分已经分析过），我同样也不推荐大家使用<code>transformSync</code>。出于性能考虑，Vite 的底层实现也是采用 <code>transform</code>这个异步的 API 进行 TS 及 JSX 的单文件转译的。</p> <h2 id="esbuild-插件开发"><a href="#esbuild-插件开发" class="header-anchor">#</a> Esbuild 插件开发</h2> <p>我们在使用 Esbuild 的时候难免会遇到一些需要加上自定义插件的场景，并且 Vite 依赖预编译的实现中大量应用了 Esbuild 插件的逻辑。因此，插件开发是 Esbuild 中非常重要的内容，</p> <h3 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h3> <p>插件开发其实就是基于原有的体系结构中进行<strong>扩展</strong>和<strong>自定义</strong>。 Esbuild 插件也不例外，通过 Esbuild 插件我们可以扩展 Esbuild 原有的路径解析、模块加载等方面的能力，并在 Esbuild 的构建过程中执行一系列自定义的逻辑</p> <p><code>Esbuild</code> 插件结构被设计为一个对象，里面有<code>name</code>和<code>setup</code>两个属性，<code>name</code>是插件的名称，<code>setup</code>是一个函数，其中入参是一个 <code>build</code> 对象，这个对象上挂载了一些钩子可供我们自定义一些钩子函数逻辑。以下是一个简单的<code>Esbuild</code>插件示例:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> envPlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'env'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^env$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      contents<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
      loader<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esbuild'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src/index.jsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  outfile<span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>
  <span class="token comment">// 应用插件</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>envPlugin<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>使用插件后效果如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 应用了 env 插件后，构建时将会被替换成 process.env 对象</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">PATH</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'env'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">PATH is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATH</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><p>那么，<code>build</code>对象上的各种钩子函数是如何使用的呢？</p> <h3 id="钩子函数的使用"><a href="#钩子函数的使用" class="header-anchor">#</a> 钩子函数的使用</h3> <h4 id="_1-onresolve-钩子-和-onload钩子"><a href="#_1-onresolve-钩子-和-onload钩子" class="header-anchor">#</a> 1. <code>onResolve</code> 钩子 和 <code>onLoad</code>钩子</h4> <p>在 Esbuild 插件中，<code>onResolve</code> 和 <code>onload</code>是两个非常重要的钩子，分别控制<strong>路径解析</strong>和<strong>模块内容加载</strong>的过程。</p> <p>首先，我们来说说上面插件示例中的两个钩子该如何使用。</p> <div class="language-js extra-class"><pre class="language-js"><code>build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^env$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  path<span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
  namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  contents<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span>
  loader<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以发现这两个钩子函数中都需要传入两个参数: <code>Options</code> 和<code>Callback</code>。</p> <p>先说说<code>Options</code>。它是一个对象，对<code>于onResolve</code> 和 <code>onload</code> 都一样，包含<code>filter</code>和<code>namespace</code>两个属性，类型定义如下:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">Options</span> <span class="token punctuation">{</span>
  filter<span class="token operator">:</span> RegExp<span class="token punctuation">;</span>
  <span class="token keyword">namespace</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>filter</code> 为必传参数，是一个正则表达式，它决定了要过滤出的特征文件。</p> <blockquote><p>📢 注意: 插件中的 filter 正则是使用 Go 原生正则实现的，为了不使性能过于劣化，规则应该尽可能严格。同时它本身和 JS 的正则也有所区别，不支持前瞻(?&lt;=)、后顾(?=)和反向引用(\1)这三种规则。</p></blockquote> <p><code>namespace</code> 为选填参数，一般在 <code>onResolve</code> 钩子中的回调参数返回<code>namespace</code>属性作为标识，我们可以在<code>onLoad</code>钩子中通过<code>namespace</code> 将模块过滤出来。如上述插件示例就在<code>onLoad</code>钩子通过<code>env-ns</code>这个 <code>namespace</code> 标识过滤出了要处理的<code>env</code>模块。</p> <p>除了 Options 参数，还有一个回调参数 <code>Callback</code>，它的类型根据不同的钩子会有所不同。相比于 Options，Callback 函数入参和返回值的结构复杂得多，涉及很多属性。不过，我们也不需要看懂每个属性的细节，先了解一遍即可，常用的一些属性会在插件实战部分讲解来讲。</p> <p>在 <code>onResolve</code> 钩子中函数参数和返回值梳理如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^env$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>args<span class="token operator">:</span> onResolveArgs<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">onResolveResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模块路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  <span class="token comment">// 父模块路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>importer<span class="token punctuation">)</span>
  <span class="token comment">// namespace 标识</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span>
  <span class="token comment">// 基准路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>resolveDir<span class="token punctuation">)</span>
  <span class="token comment">// 导入方式，如 import、require</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>kind<span class="token punctuation">)</span>
  <span class="token comment">// 额外绑定的插件数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>pluginData<span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 错误信息</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 是否需要 external</span>
      external<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">// namespace 标识</span>
      namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span><span class="token punctuation">;</span>
      <span class="token comment">// 模块路径</span>
      path<span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      <span class="token comment">// 额外绑定的插件数据</span>
      pluginData<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token comment">// 插件名称</span>
      pluginName<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
      <span class="token comment">// 设置为 false，如果模块没有被用到，模块代码将会在产物中会删除。否则不会这么做</span>
      sideEffects<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">// 添加一些路径后缀，如`?xxx`</span>
      suffix<span class="token operator">:</span> <span class="token string">'?xxx'</span><span class="token punctuation">,</span>
      <span class="token comment">// 警告信息</span>
      warnings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 仅仅在 Esbuild 开启 watch 模式下生效</span>
      <span class="token comment">// 告诉 Esbuild 需要额外监听哪些文件/目录的变化</span>
      watchDirs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      watchFiles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>onLoad</code> 钩子中函数参数和返回值梳理如下:</p> <div class="language-js extra-class"><pre class="language-js"><code>build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">'env-ns'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>args<span class="token operator">:</span> OnLoadArgs<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">OnLoadResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模块路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// namespace 标识</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 后缀信息</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 额外的插件数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>pluginData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 模块具体内容</span>
      contents<span class="token operator">:</span> <span class="token string">'省略内容'</span><span class="token punctuation">,</span>
      <span class="token comment">// 错误信息</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 指定 loader，如`js`、`ts`、`jsx`、`tsx`、`json`等等</span>
      loader<span class="token operator">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
      <span class="token comment">// 额外的插件数据</span>
      pluginData<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token comment">// 插件名称</span>
      pluginName<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
      <span class="token comment">// 基准路径</span>
      resolveDir<span class="token operator">:</span> <span class="token string">'./dir'</span><span class="token punctuation">,</span>
      <span class="token comment">// 警告信息</span>
      warnings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 同上</span>
      watchDirs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      watchFiles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-其他钩子"><a href="#_2-其他钩子" class="header-anchor">#</a> 2. 其他钩子</h4> <p>在 build 对象中，除了<code>onResolve</code>和<code>onLoad</code>，还有<code>onStart</code>和<code>onEnd</code>两个钩子用来在构建开启和结束时执行一些自定义的逻辑，使用上比较简单，如下面的例子所示:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> examplePlugin <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'example'</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    build<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'build started'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    build<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">buildResult</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>buildResult<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 构建元信息</span>
      <span class="token comment">// 获取元信息后做一些自定义的事情，比如生成 HTML</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buildResult<span class="token punctuation">.</span>metafile<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在使用这些钩子的时候，有 2 点需要注意。</p> <ol><li>onStart 的执行时机是在每次 build 的时候，包括触发 <code>watch</code> 或者 <code>serve</code>模式下的重新构建。</li> <li>onEnd 钩子中如果要拿到 <code>metafile</code>，必须将 Esbuild 的构建配置中<code>metafile</code>属性设为 <code>true</code>。</li></ol> <p>接下来我们进入插件实战，通过编写一些特定功能的插件来熟悉 Esbuild 插件的开发流程和技巧。</p> <h3 id="实战-1-cdn-依赖拉取插件"><a href="#实战-1-cdn-依赖拉取插件" class="header-anchor">#</a> 实战 1: CDN 依赖拉取插件</h3> <p><code>Esbuild</code> 原生不支持通过 HTTP 从 CDN 服务上拉取对应的第三方依赖资源，如下代码所示:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/index.jsx</span>
<span class="token comment">// react-dom 的内容全部从 CDN 拉取</span>
<span class="token comment">// 这段代码目前是无法运行的</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;https://cdn.skypack.dev/react-dom&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">Greet</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello<span class="token punctuation">,</span> juejin<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Greet <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>示例代码中我们用到了 <code>Skypack</code> 这个提供 npm 第三方包 ESM 产物的 <code>CDN 服务</code>，我们可以通过 url 访问第三方包的资源，如下图所示:</p> <img src="/yg-notes/assets/vite/9-4.webp"> <p>现在我们需要通过 Esbuild 插件来识别这样的 url 路径，然后从网络获取模块内容并让 Esbuild 进行加载，甚至不再需要<code>npm install</code>安装依赖了，这看上去是不是很酷呢？</p> <blockquote><p>顺便提一句，ESM CDN 作为面向未来的前端基础设施，对 Vite 的影响也至关重大，可以极大提升 Vite 在生产环境下的构建性能。这部分内容我们将在<strong>高级应用</strong>这一章展开介绍。</p></blockquote> <p>我们先从最简单的版本开始写起:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// http-import-plugin.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;esbuild:http&quot;</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1. 拦截 CDN 请求</span>
    build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      namespace<span class="token operator">:</span> <span class="token string">&quot;http-url&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 通过 fetch 请求加载 CDN 资源</span>
    build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">&quot;http-url&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Downloading: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> lib <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;https&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> https <span class="token operator">:</span> http<span class="token punctuation">;</span>
          <span class="token keyword">let</span> req <span class="token operator">=</span> lib
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">301</span><span class="token punctuation">,</span> <span class="token number">302</span><span class="token punctuation">,</span> <span class="token number">307</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 重定向</span>
                <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>location<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                req<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 响应成功</span>
                <span class="token keyword">let</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> failed: status </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>statusCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> contents <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后我们新建<code>build.js</code>文件，内容如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> build <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;esbuild&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> httpImport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./http-import-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    absWorkingDir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/index.jsx&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    outdir<span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>
    bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">&quot;esm&quot;</span><span class="token punctuation">,</span>
    splitting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sourcemap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">httpImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;🚀 Build Finished!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">runBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过<code>node build.js</code>执行打包脚本，发现插件不能 work，抛出了这样一个错误:</p> <img src="/yg-notes/assets/vite/9-5.webp"> <p>这是为什么呢？你可以回过头观察一下第三方包的响应内容:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span><span class="token keyword">default</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>进一步查看还有更多的模块内容:</p> <img src="/yg-notes/assets/vite/9-6.webp"> <p>因此我们可以得出一个结论：除了要解析 <code>react-dom</code> 这种<strong>直接依赖的路径</strong>，还要解析它依赖的路径，也就是<strong>间接依赖的路径</strong>。</p> <p>那如何来实现这个效果呢？我们不妨加入这样一段<code>onResolve</code>钩子逻辑:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拦截间接依赖的路径，并重写路径</span>
<span class="token comment">// tip: 间接依赖同样会被自动带上 `http-url`的 namespace</span>
build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> namespace<span class="token operator">:</span> <span class="token string">&quot;http-url&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 重写路径</span>
  path<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> args<span class="token punctuation">.</span>importer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  namespace<span class="token operator">:</span> <span class="token string">&quot;http-url&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>加了这段逻辑后，Esbuild 路径解析的流程如下:</p> <img src="/yg-notes/assets/vite/9-7.webp"> <p>现在我们再次执行<code>node build.js</code>，发现依赖已经成功下载并打包了。</p> <img src="/yg-notes/assets/vite/9-8.webp"> <h3 id="实战-2-实现-html-构建插件"><a href="#实战-2-实现-html-构建插件" class="header-anchor">#</a> 实战 2: 实现 HTML 构建插件</h3> <p>Esbuild 作为一个前端打包工具，本身并不具备 HTML 的构建能力。也就是说，当它把 js/css 产物打包出来的时候，并不意味着前端的项目可以直接运行了，我们还需要一份对应的入口 HTML 文件。而这份 HTML 文件当然可以手写一个，但手写显得比较麻烦，尤其是产物名称带哈希值的时候，每次打包完都要替换路径。那么，我们能不能通过 Esbuild 插件的方式来自动化地生成 HTML 呢？</p> <p>刚才我们说了，在 Esbuild 插件的 <code>onEnd</code> 钩子中可以拿到 <code>metafile</code> 对象的信息。那么，这个对象究竟什么样呢？</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inputs&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">/* 省略内容 */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;output&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dist/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      entryPoint<span class="token operator">:</span> 'src/index.jsx'<span class="token punctuation">,</span>
      inputs<span class="token operator">:</span> <span class="token punctuation">{</span>
        'http-url<span class="token operator">:</span>https<span class="token operator">:</span><span class="token comment">//cdn.skypack.dev/-/object-assign@v4.1.1-LbCnB3r2y2yFmhmiCfPn/dist=es2019,mode=imports/optimized/object-assign.js': { bytesInOutput: 1792 },</span>
        'http-url<span class="token operator">:</span>https<span class="token operator">:</span><span class="token comment">//cdn.skypack.dev/-/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/dist=es2019,mode=imports/optimized/react.js': { bytesInOutput: 10396 },</span>
        'http-url<span class="token operator">:</span>https<span class="token operator">:</span><span class="token comment">//cdn.skypack.dev/-/scheduler@v0.20.2-PAU9F1YosUNPKr7V4s0j/dist=es2019,mode=imports/optimized/scheduler.js': { bytesInOutput: 9084 },</span>
        'http-url<span class="token operator">:</span>https<span class="token operator">:</span><span class="token comment">//cdn.skypack.dev/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js': { bytesInOutput: 183229 },</span>
        'http-url<span class="token operator">:</span>https<span class="token operator">:</span><span class="token comment">//cdn.skypack.dev/react-dom': { bytesInOutput: 0 },</span>
        'src/index.jsx'<span class="token operator">:</span> <span class="token punctuation">{</span> bytesInOutput<span class="token operator">:</span> <span class="token number">178</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      bytes<span class="token operator">:</span> <span class="token number">205284</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dist/index.js.map&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">/* 省略内容 */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从<code>outputs</code>属性中我们可以看到产物的路径，这意味着我们可以在插件中拿到所有 <code>js</code> 和 <code>css</code> 产物，然后自己组装、生成一个 HTML，实现自动化生成 HTML 的效果。</p> <p>我们接着来实现一下这个插件的逻辑，首先新建<code>html-plugin.js</code>，内容如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs/promises&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果是版本较低的node, 12.x  需要改成 const fs = require('fs').promises</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createScript<span class="token punctuation">,</span> createLink<span class="token punctuation">,</span> generateHTML <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;esbuild:html&quot;</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      build<span class="token punctuation">.</span><span class="token function">onEnd</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">buildResult</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buildResult<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> metafile <span class="token punctuation">}</span> <span class="token operator">=</span> buildResult<span class="token punctuation">;</span>
        <span class="token comment">// 1. 拿到 metafile 后获取所有的 js 和 css 产物路径</span>
        <span class="token keyword">const</span> scripts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> links <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metafile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> outputs <span class="token punctuation">}</span> <span class="token operator">=</span> metafile<span class="token punctuation">;</span>
          <span class="token keyword">const</span> assets <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">;</span>

          assets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">asset</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>asset<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              scripts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createScript</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>asset<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.css&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              links<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createLink</span><span class="token punctuation">(</span>asset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. 拼接 HTML 内容</span>
        <span class="token keyword">const</span> templateContent <span class="token operator">=</span> <span class="token function">generateHTML</span><span class="token punctuation">(</span>scripts<span class="token punctuation">,</span> links<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. HTML 写入磁盘</span>
        <span class="token keyword">const</span> templatePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>templatePath<span class="token punctuation">,</span> templateContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
<span class="token comment">// util.js</span>
<span class="token comment">// 一些工具函数的实现</span>
<span class="token keyword">const</span> <span class="token function-variable function">createScript</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script type=&quot;module&quot; src=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;/script&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">createLink</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;link rel=&quot;stylesheet&quot; href=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;&lt;/link&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">generateHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">scripts<span class="token punctuation">,</span> links</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot; /&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
  &lt;title&gt;Esbuild App&lt;/title&gt;
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>links<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
&lt;/head&gt;

&lt;body&gt;
  &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scripts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
&lt;/body&gt;

&lt;/html&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> createLink<span class="token punctuation">,</span> createScript<span class="token punctuation">,</span> generateHTML <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们在 <code>build.js</code> 中引入 <code>html</code> 插件:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./html-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// esbuild 配置</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token comment">// 省略其它插件</span>
  <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>然后执行<code>node build.js</code>对项目进行打包，你就可以看到 <code>index.html</code> 已经成功输出到根目录。接着，我们通过 <code>serve</code> 起一个本地静态文件服务器:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>// <span class="token number">1</span>. 全局安装 serve
<span class="token function">npm</span> i -g serve
// <span class="token number">2</span>. 在项目根目录执行
serve <span class="token builtin class-name">.</span>
</code></pre></div><p>可以看到如下的界面:</p> <img src="/yg-notes/assets/vite/9-9.webp"> <p>再访问<code>localhost:3000</code>，会默认访问到 <code>index.html</code> 的内容：</p> <img src="/yg-notes/assets/vite/9-10.webp"> <p>这样一来，应用的内容就成功显示了，也说明 <code>HTML</code> 插件正常生效了。当然，如果要做一个足够通用的 HTML 插件，还需要考虑诸多的因素，比如<code>自定义 HTML 内容</code>、<code>自定义公共前缀(publicPath)</code>、<code>自定义 script 标签类型</code>以及 <code>多入口打包</code>等等，大家感兴趣的话可以自行扩展。(可参考这个<a href="https://github.com/sanyuan0704/ewas/blob/main/packages/esbuild-plugin-html/src/index.ts" target="_blank" rel="noopener noreferrer">开源插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>首先你可以通过<strong>命令行方式</strong>和<strong>代码调用方式</strong>两种方式来使用 Esbuild。对后者而言，我们需要使用到 Esbuild 中两个重要的 API，分别是<code>Build API</code>和<code>Transform API</code>，为了避免同步方法所导致的性能问题，我推荐你使用<strong>异步方式</strong>进行调用。</p> <p>其次，我用一个简单的<code>env</code>插件示例带你学习了 Esbuild 插件的代码结构和基本概念，并进行了插件开发实战，开发了两个复杂度比较高的插件，分别是 <code>CDN 依赖拉取插件</code>和<code>HTML 构建插件</code>。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/28/2022, 2:14:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/yg-notes/vite/chapter3/" class="prev router-link-active">
        Esbuild
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/yg-notes/assets/js/app.fe4da5f9.js" defer></script><script src="/yg-notes/assets/js/2.7fcefaab.js" defer></script><script src="/yg-notes/assets/js/29.5bda923a.js" defer></script>
  </body>
</html>
